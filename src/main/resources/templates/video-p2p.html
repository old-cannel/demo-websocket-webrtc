<!DOCTYPE html>
<!--
 *  Copyright (c) 2015 The WebRTC project authors. All Rights Reserved.
 *
 *  Use of this source code is governed by a BSD-style license
 *  that can be found in the LICENSE file in the root of the source
 *  tree.
-->
<html>
<head>

    <meta charset="utf-8">
    <meta name="description" content="WebRTC code samples">
    <meta name="viewport" content="width=device-width, user-scalable=yes, initial-scale=1, maximum-scale=1">
    <meta itemprop="description" content="Client-side WebRTC code samples">
    <meta itemprop="name" content="WebRTC code samples">
    <meta name="mobile-web-app-capable" content="yes">
    <meta id="theme-color" name="theme-color" content="#ffffff">

    <base target="_blank">

    <title>Munge SDP</title>

    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <script src="/js/jquery-3.3.1.min.js"></script>
    <script src="/js/sockjs.min.js"></script>
    <script src="/js/stomp.min.js"></script>
    <script src="/js/adapter.js" type="text/javascript"></script>
    <script>
        //开始websocket链接信令服务器
        var stompClient = null;
        var sessionId=null;
        var room =null;

        function connect() {
             room = $("#room").val();
            var socket = new SockJS('/my-websocket');
            stompClient = Stomp.over(socket);
            stompClient.connect({}, function (frame) {
                setConnected(true);
                console.log('Connected: ' + frame);
                stompClient.subscribe('/topic/connect/' + room, function (message) {

                    if(sessionId!=JSON.parse(message.body).sessionId){
                        //打印收到不是自己的消息
                        console.info(message);
                    }
                });
                stompClient.subscribe('/user/topic/sessionId', function (msg) {
                    //收到自己的sessionId
                    console.info(msg);
                    sessionId=msg.body;
                });
                //获取自己的sessionId
                stompClient.send("/app/sessionId", {});
            });
        }

        function send( message) {
            stompClient.send("/app/connect/" + room, {}, JSON.stringify({'message': message}));
        }

        function setConnected(connected) {
            $("#connect").prop("disabled", connected);
            $("#disconnect").prop("disabled", !connected);
        }

        function disconnect() {
            if (stompClient !== null) {
                stompClient.disconnect();
            }
            setConnected(false);
            console.log("Disconnected");
        }

        //视频聊天代码
        var signalingChannel, key, id,
            haveLocalMedia = false,
            weWaited = false,
            myVideoStream, myVideo,
            yourVideoStream, yourVideo,
            doNothing = function() {},
            pc, dc, data = {},
            constraints = {mandatory: {
                    OfferToReceiveAudio: true,
                    OfferToReceiveVideo: true}};

        window.onload = function () {
            myVideo = document.getElementById("myVideo");
            yourVideo = document.getElementById("yourVideo");
            getMedia();
        }

        function getMedia() {
            getUserMedia(opt, successCallback, errorCallback);
        }

        function successCallback(stream) {
            myVideoStream = stream;
            attachMediaStream(myVideo, myVideoStream);
            attachMediaStream(otherVideo, myVideoStream);
        }

        function errorCallback(error) {
            console.log("getUserMedia error: ", error);
        }

        $(function () {
            $("form").on('submit', function (e) {
                e.preventDefault();
            });
            $("#connect").click(function () {
                connect();
            });
            $("#disconnect").click(function () {
                disconnect();
            });
        });

    </script>

</head>

<body>
<h1 style="text-align: center">webrtc demo</h1>

<div id="main-content" class="container">
    <div class="row">
        <div class="col-md-6">
            <form class="form-inline">
                <div class="form-group">
                    <label for="connect">输入房间号开始聊天:</label>
                    <input type="text" id="room" class="form-control" placeholder="Your room here...">
                    <button id="connect" class="btn btn-default" type="submit">Connect</button>
                    <button id="disconnect" class="btn btn-default" type="submit" disabled="disabled">Disconnect
                    </button>
                </div>
            </form>
        </div>

    </div>
    <hr/>
    <div id="container" style="width: 640px;margin: 0;padding: 0;">

        <video id="otherVideo" playsinline autoplay muted></video>
        <video id="yourVideo" playsinline autoplay muted
               style="position: relative;  float: right; bottom: 126px;    width: 160px;"></video>
    </div>
</div>

</body>
</html>
